# Moose Agent Organizational Workflow
**Complete System Architecture - Phase 2.0-4.1**

---

## Workflow Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ HUMAN                                                     â”‚
â”‚ â€¢ Uploads technical specifications                          â”‚
â”‚ â€¢ Reviews escalations from Client Manager (with options)    â”‚
â”‚ â€¢ Approves high-risk Work Orders from Director              â”‚
â”‚ â€¢ Makes final decisions on escalated issues                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—ï¸ ARCHITECT (Phase 2.0)                                    â”‚
â”‚ Strategic Decomposition Agent                                â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Analyzes spec complexity & scope                          â”‚
â”‚ â€¢ Maps dependencies (sequential vs parallel)                â”‚
â”‚ â€¢ Estimates context/token budgets per chunk                 â”‚
â”‚ â€¢ Creates Work Orders with acceptance criteria              â”‚
â”‚                                                              â”‚
â”‚ Outputs: WO queue + decomposition documentation             â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Writes: work_orders (creates initial records)             â”‚
â”‚ â€¢ References: contracts (for boundary validation)           â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Approve or assess risk (Director's job)                   â”‚
â”‚ â€¢ Execute code generation (Proposer's job)                  â”‚
â”‚ â€¢ Handle runtime coordination (Manager's job)               â”‚
â”‚ â€¢ Make escalation decisions (Client Manager's job)          â”‚
â”‚ â€¢ Apply code to repository (Orchestrator's job)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš–ï¸ DIRECTOR (Phase 2.1)                                      â”‚
â”‚ Senior Governance Agent                                      â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Receive Work Orders from Architect                        â”‚
â”‚ â€¢ Validate against contracts using contract-validator.ts    â”‚
â”‚   - Detect breaking changes                                 â”‚
â”‚   - Verify API compatibility                                â”‚
â”‚   - Check domain model consistency                          â”‚
â”‚ â€¢ Risk assessment per Work Order:                           â”‚
â”‚   - Low: Config changes, documentation, non-breaking adds   â”‚
â”‚   - Medium: Schema changes, new APIs, refactoring           â”‚
â”‚   - High: Breaking changes, architecture mods, security     â”‚
â”‚ â€¢ Decision logging with reasoning (full audit trail)        â”‚
â”‚ â€¢ Progressive trust system:                                 â”‚
â”‚   - Track pattern confidence scores                         â”‚
â”‚   - Auto-approve low-risk orders when confidence >0.95      â”‚
â”‚   - Require human approval for medium/high risk             â”‚
â”‚ â€¢ Route high-risk Work Orders to human approval queue       â”‚
â”‚ â€¢ Hand approved Work Orders to Manager                      â”‚
â”‚                                                              â”‚
â”‚ Outputs: Approved/rejected WOs with justification,          â”‚
â”‚          Risk classifications, Decision audit trail          â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Reads: work_orders, contracts, pattern_confidence_scores  â”‚
â”‚ â€¢ Writes: decision_logs, updates work_orders.status         â”‚
â”‚ â€¢ References: playbook_memory for trust patterns            â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Decompose technical specs (Architect's job)               â”‚
â”‚ â€¢ Generate code (Proposer's job)                            â”‚
â”‚ â€¢ Handle escalations (Client Manager's job)                 â”‚
â”‚ â€¢ Coordinate runtime execution (Manager's job)              â”‚
â”‚ â€¢ Route to specific Proposers (Manager's job)               â”‚
â”‚ â€¢ Apply code changes (Orchestrator's job)                   â”‚
â”‚                                                              â”‚
â”‚ Files: src/lib/llm-service.ts, src/lib/contract-validator.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ MANAGER (Phase 4.1)                                       â”‚
â”‚ Tactical Coordination Agent                                  â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Receive approved Work Orders from Director                â”‚
â”‚ â€¢ Context-aware routing to appropriate Proposer:            â”‚
â”‚   - Complexity analysis (7 factors)                         â”‚
â”‚   - Historical success patterns (outcome_vectors)           â”‚
â”‚   - Current budget constraints (system_config)              â”‚
â”‚   - Proposer availability and capability                    â”‚
â”‚   - Hard Stop keyword detection (security/architecture)     â”‚
â”‚ â€¢ Predictive resource allocation:                           â”‚
â”‚   - Estimate token usage from historical data               â”‚
â”‚   - Predict execution time                                  â”‚
â”‚   - Forecast cost per Work Order                            â”‚
â”‚ â€¢ Budget enforcement (three-tier system):                   â”‚
â”‚   - Soft cap ($20 daily default): Alert, continue           â”‚
â”‚   - Hard cap ($50 daily): Force cheapest model              â”‚
â”‚   - Emergency kill ($100 daily): Stop all operations        â”‚
â”‚   - Hard Stop override: force claude-sonnet-4 if needed     â”‚
â”‚ â€¢ Retry ladder with pattern-aware re-prompting:             â”‚
â”‚   - Attempt 1: Standard prompt                              â”‚
â”‚   - Attempt 2: Add failure context from attempt 1           â”‚
â”‚   - Attempt 3: Switch model or escalate                     â”‚
â”‚ â€¢ Real-time capacity management:                            â”‚
â”‚   - Monitor concurrent Work Orders                          â”‚
â”‚   - Load balance across available Proposers                 â”‚
â”‚   - Queue orders when capacity constrained                  â”‚
â”‚ â€¢ Track performance metrics per Proposer                    â”‚
â”‚                                                              â”‚
â”‚ Outputs: Routing decisions, Retry strategies,               â”‚
â”‚          Resource allocation adjustments, Budget alerts      â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Reads: work_orders, proposer_configs, outcome_vectors,    â”‚
â”‚          system_config, cost_tracking                        â”‚
â”‚ â€¢ Writes: routing metadata to work_orders.metadata          â”‚
â”‚ â€¢ Queries: Daily cost totals from cost_tracking             â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Create or decompose Work Orders (Architect's job)         â”‚
â”‚ â€¢ Approve Work Orders (Director's job)                      â”‚
â”‚ â€¢ Generate code (Proposer's job)                            â”‚
â”‚ â€¢ Escalate to humans (Client Manager's job)                 â”‚
â”‚ â€¢ Make risk assessments (Director's job)                    â”‚
â”‚ â€¢ Apply code to repository (Orchestrator's job)             â”‚
â”‚                                                              â”‚
â”‚ Files: src/lib/proposer-registry.ts,                        â”‚
â”‚        src/lib/config-services.ts                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’» PROPOSERS (Phase 2.2)                                     â”‚
â”‚ Code Generation Agents                                       â”‚
â”‚                                                              â”‚
â”‚ Models in Registry:                                          â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Claude Sonnet 4.5   â”‚  â”‚ GPT-4o-mini         â”‚           â”‚
â”‚ â”‚                     â”‚  â”‚                     â”‚           â”‚
â”‚ â”‚ â€¢ Complexity â‰¥1.0   â”‚  â”‚ â€¢ Complexity <0.3   â”‚           â”‚
â”‚ â”‚ â€¢ All Hard Stops    â”‚  â”‚ â€¢ Simple tasks only â”‚           â”‚
â”‚ â”‚ â€¢ $3.00/$15.00      â”‚  â”‚ â€¢ $0.15/$0.60       â”‚           â”‚
â”‚ â”‚   per 1M tokens     â”‚  â”‚   per 1M tokens     â”‚           â”‚
â”‚ â”‚                     â”‚  â”‚                     â”‚           â”‚
â”‚ â”‚ Use cases:          â”‚  â”‚ Use cases:          â”‚           â”‚
â”‚ â”‚ â€¢ Architecture      â”‚  â”‚ â€¢ Simple CRUD       â”‚           â”‚
â”‚ â”‚ â€¢ Security fixes    â”‚  â”‚ â€¢ Config changes    â”‚           â”‚
â”‚ â”‚ â€¢ Complex logic     â”‚  â”‚ â€¢ Documentation     â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Receive routed Work Orders from Manager                   â”‚
â”‚ â€¢ Complexity analysis using 7 factors:                      â”‚
â”‚   1. Architectural impact (system structure changes)        â”‚
â”‚   2. Integration points (systems/APIs affected)             â”‚
â”‚   3. Data transformations (complex data manipulation)       â”‚
â”‚   4. Error handling requirements (exception scenarios)      â”‚
â”‚   5. Testing complexity (test cases needed)                 â”‚
â”‚   6. Security implications (auth, encryption, validation)   â”‚
â”‚   7. Performance considerations (scalability, optimization) â”‚
â”‚ â€¢ Generate complete, deployable code (not instructions)     â”‚
â”‚ â€¢ Self-refinement (Phase 2.2.6):                            â”‚
â”‚   - Detect quality issues:                                  â”‚
â”‚     * TypeScript compilation errors                         â”‚
â”‚     * Contract violations                                   â”‚
â”‚     * Logic inconsistencies                                 â”‚
â”‚   - Regenerate with learned context from failures           â”‚
â”‚   - Maximum 2-3 refinement attempts per Work Order          â”‚
â”‚   - Feed successful patterns to playbook_memory             â”‚
â”‚   - Cost tracking per refinement cycle                      â”‚
â”‚ â€¢ Parallel mode (Phase 2.2.7):                              â”‚
â”‚   - Medium-risk orders: both models compete                 â”‚
â”‚   - Orchestrator tests both outputs                         â”‚
â”‚   - Best solution (quality + cost) wins                     â”‚
â”‚ â€¢ Cost tracking per generation + refinement                 â”‚
â”‚ â€¢ Hard Stop enforcement: 20 keywords force claude-sonnet-4  â”‚
â”‚                                                              â”‚
â”‚ Hard Stop Keywords (20 total):                               â”‚
â”‚ Security (12): SQL injection, XSS, CSRF, authentication,    â”‚
â”‚   authorization, encryption, password hashing, API keys,    â”‚
â”‚   secrets management, access control, input validation,     â”‚
â”‚   sanitization                                               â”‚
â”‚ Architecture (8): API contract, schema change, breaking     â”‚
â”‚   change, database migration, event schema, integration     â”‚
â”‚   contract, system design, architectural decision           â”‚
â”‚                                                              â”‚
â”‚ Outputs: Complete code with file paths and diffs,           â”‚
â”‚          Complexity analysis metadata, Cost breakdown,       â”‚
â”‚          Refinement history, Routing justification           â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Reads: work_orders, proposer_configs, playbook_memory     â”‚
â”‚ â€¢ Writes: cost_tracking, outcome_vectors,                   â”‚
â”‚          updates to work_orders.metadata                     â”‚
â”‚ â€¢ Updates: pattern_confidence_scores after successful       â”‚
â”‚            patterns                                          â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Decide routing (Manager's job)                            â”‚
â”‚ â€¢ Apply code to repo (Orchestrator's job)                   â”‚
â”‚ â€¢ Validate execution results (Sentinel's job)               â”‚
â”‚ â€¢ Approve Work Orders (Director's job)                      â”‚
â”‚ â€¢ Handle escalations (Client Manager's job)                 â”‚
â”‚                                                              â”‚
â”‚ Files: src/lib/enhanced-proposer-service.ts,                â”‚
â”‚        src/lib/complexity-analyzer.ts,                       â”‚
â”‚        src/lib/claude-sonnet-proposer.ts                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ ORCHESTRATOR (Phase 2.3/3.2 - CONSOLIDATED)              â”‚
â”‚ Aider-based Execution Infrastructure                         â”‚
â”‚ ** NOT AN AGENT - Infrastructure/Tooling built on Aider CLI â”‚
â”‚                                                              â”‚
â”‚ Components:                                                  â”‚
â”‚ 1. GitHub Actions workflows (CI/CD orchestration)           â”‚
â”‚ 2. Aider CLI (git-aware code application engine)            â”‚
â”‚ 3. PR management scripts (metadata, auto-merge logic)       â”‚
â”‚ 4. Container infrastructure (ephemeral execution envs)      â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Receive generated code from Proposers                     â”‚
â”‚ â€¢ Spin up ephemeral Aider instances in containers:          â”‚
â”‚   - Isolated git environment per Work Order                 â”‚
â”‚   - Clean state (no cross-contamination)                    â”‚
â”‚   - Resource limits (CPU, memory, timeout)                  â”‚
â”‚ â€¢ Apply code via Aider CLI:                                 â”‚
â”‚   - Aider receives Proposer's code/instructions             â”‚
â”‚   - Makes git-aware edits to repository files               â”‚
â”‚   - Validates changes can be applied cleanly                â”‚
â”‚   - Reports conflicts or issues                             â”‚
â”‚ â€¢ Live environment feedback via Aider:                      â”‚
â”‚   - Check current file structure (what actually exists)     â”‚
â”‚   - Verify imports resolve (dependencies available)         â”‚
â”‚   - Test if code compiles (TypeScript/language checks)      â”‚
â”‚   - Query actual state vs Proposer assumptions              â”‚
â”‚   - Feed discrepancies back to Proposer for refinement      â”‚
â”‚ â€¢ Branch management:                                         â”‚
â”‚   - Create feature branches: feature/wo-[id]-[description]  â”‚
â”‚   - Apply commits with descriptive messages                 â”‚
â”‚   - Push to remote repository                               â”‚
â”‚ â€¢ Pull Request creation with enhanced metadata:             â”‚
â”‚   - Risk level (from Director)                              â”‚
â”‚   - Proposer used (model name)                              â”‚
â”‚   - Complexity score (0.0-1.0)                              â”‚
â”‚   - Work Order ID (traceability)                            â”‚
â”‚   - Cost tracking (dollars spent)                           â”‚
â”‚   - Hard Stop flag (if applicable)                          â”‚
â”‚ â€¢ Trigger GitHub Actions workflows:                         â”‚
â”‚   - Unit tests                                              â”‚
â”‚   - Integration tests                                       â”‚
â”‚   - Build validation                                        â”‚
â”‚   - Linting/formatting checks                               â”‚
â”‚ â€¢ Auto-merge logic for low-risk PRs:                        â”‚
â”‚   - Wait for Sentinel approval (all checks pass)            â”‚
â”‚   - Verify risk_level = "low"                               â”‚
â”‚   - Check pattern confidence >0.95                          â”‚
â”‚   - Execute merge if conditions met                         â”‚
â”‚ â€¢ Rollback capability:                                       â”‚
â”‚   - Revert bundled changes on failure                       â”‚
â”‚   - Clean rollback without conflicts                        â”‚
â”‚   - Notify affected agents                                  â”‚
â”‚ â€¢ Collect and report execution results:                     â”‚
â”‚   - Success/failure status                                  â”‚
â”‚   - Test results                                            â”‚
â”‚   - Build logs                                              â”‚
â”‚   - Performance metrics                                     â”‚
â”‚ â€¢ Teardown ephemeral environments after completion          â”‚
â”‚                                                              â”‚
â”‚ Aider-Specific Capabilities:                                 â”‚
â”‚ â€¢ Git-aware editing: Understands repo structure, makes      â”‚
â”‚   targeted changes                                           â”‚
â”‚ â€¢ Live state queries: Can check what files exist, what      â”‚
â”‚   imports are available                                      â”‚
â”‚ â€¢ Conflict detection: Identifies merge conflicts before     â”‚
â”‚   they reach GitHub                                          â”‚
â”‚ â€¢ Atomic operations: Changes applied as coherent units      â”‚
â”‚ â€¢ Rollback support: Clean undo of changes if needed         â”‚
â”‚                                                              â”‚
â”‚ Outputs: Feature branches, Pull requests with metadata,     â”‚
â”‚          GitHub Actions triggers, Deployment logs,           â”‚
â”‚          Test results for Sentinel, Live environment reports,â”‚
â”‚          Rollback operations when needed                     â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Reads: work_orders                                         â”‚
â”‚ â€¢ Writes: github_events, updates work_orders                â”‚
â”‚          (github_pr_number, github_pr_url, github_branch),   â”‚
â”‚          outcome_vectors (execution metrics)                 â”‚
â”‚                                                              â”‚
â”‚ Integration Points:                                          â”‚
â”‚ â€¢ Receives code from Proposers                              â”‚
â”‚ â€¢ Spins up Aider CLI in containers                          â”‚
â”‚ â€¢ Aider provides live feedback to Proposers (refinement)    â”‚
â”‚ â€¢ Triggers GitHub Actions                                   â”‚
â”‚ â€¢ Reports results to Sentinel (via Actions outcomes)        â”‚
â”‚ â€¢ Notifies Client Manager on failures                       â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Make approval decisions (Director's job)                  â”‚
â”‚ â€¢ Generate code (Proposer's job)                            â”‚
â”‚ â€¢ Evaluate quality (Sentinel's job)                         â”‚
â”‚ â€¢ Route Work Orders (Manager's job)                         â”‚
â”‚ â€¢ Handle escalations (Client Manager's job)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ GitHub Actions (CI/CD)                                    â”‚
â”‚ â€¢ Runs tests (unit, integration, E2E)                       â”‚
â”‚ â€¢ Executes builds                                            â”‚
â”‚ â€¢ Performs linting/formatting checks                         â”‚
â”‚ â€¢ Reports results                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ›¡ï¸ SENTINEL (Phase 3.1)                                      â”‚
â”‚ Adaptive Quality Gates Agent                                 â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Parse GitHub Actions results from Orchestrator executions â”‚
â”‚ â€¢ Interpret test outcomes (not just pass/fail binary):      â”‚
â”‚   - Pass: All tests passed                                  â”‚
â”‚   - Fail: Real failures requiring attention                 â”‚
â”‚   - Flaky: Known intermittent failures (false positives)    â”‚
â”‚ â€¢ Adaptive thresholds based on historical baselines:        â”‚
â”‚   - Calculate Â±5% variance from outcome_vectors             â”‚
â”‚   - Adjust pass thresholds per test suite                   â”‚
â”‚   - Account for environmental fluctuations                  â”‚
â”‚ â€¢ False-positive pattern learning:                          â”‚
â”‚   - Track tests with high flake rates (>10%)                â”‚
â”‚   - Identify environmental issues (timeouts, race conds)    â”‚
â”‚   - Build ignore patterns for known false positives         â”‚
â”‚   - Store patterns in pattern_confidence_scores             â”‚
â”‚ â€¢ Custom rule synthesis (project-specific quality rules):   â”‚
â”‚   - Learn from repeated failure patterns                    â”‚
â”‚   - Generate custom validation rules                        â”‚
â”‚   - Store in playbook_memory for reuse                      â”‚
â”‚ â€¢ Severity drift detection:                                 â”‚
â”‚   - Monitor quality trends over time                        â”‚
â”‚   - Alert when quality degrades >10% from baseline          â”‚
â”‚   - Trigger preventive escalations                          â”‚
â”‚ â€¢ Concurrent validation streams:                            â”‚
â”‚   - Handle multiple PRs in parallel                         â”‚
â”‚   - Isolate results per Work Order                          â”‚
â”‚   - Prevent cross-contamination                             â”‚
â”‚ â€¢ Hard fail detection â†’ trigger Client Manager escalation:  â”‚
â”‚   - Repeated failures after retries                         â”‚
â”‚   - Critical test failures                                  â”‚
â”‚   - Security/compliance violations                          â”‚
â”‚ â€¢ Learn from human override decisions:                      â”‚
â”‚   - Track when humans merge despite warnings                â”‚
â”‚   - Adjust thresholds based on overrides                    â”‚
â”‚   - Reduce false-positive rate over time                    â”‚
â”‚                                                              â”‚
â”‚ Outputs: Pass/fail decisions per Work Order,                â”‚
â”‚          Quality metrics, False-positive patterns,           â”‚
â”‚          Escalation triggers, Custom validation rules,       â”‚
â”‚          Quality trend reports                               â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Reads: github_events (Actions results),                   â”‚
â”‚          outcome_vectors (historical baselines)              â”‚
â”‚ â€¢ Writes: outcome_vectors (new execution results),          â”‚
â”‚           pattern_confidence_scores (false-positive          â”‚
â”‚           patterns), playbook_memory (custom rules)          â”‚
â”‚ â€¢ Triggers: escalations (on hard fails)                     â”‚
â”‚                                                              â”‚
â”‚ Integration Points:                                          â”‚
â”‚ â€¢ Receives GitHub Actions results via Orchestrator          â”‚
â”‚ â€¢ Analyzes test outcomes                                    â”‚
â”‚ â€¢ Notifies Orchestrator: approve auto-merge or block        â”‚
â”‚ â€¢ Escalates to Client Manager on hard failures              â”‚
â”‚ â€¢ Feeds learning patterns to playbook_memory                â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Generate code (Proposer's job)                            â”‚
â”‚ â€¢ Create escalation options (Client Manager's job)          â”‚
â”‚ â€¢ Apply fixes (Orchestrator's job)                          â”‚
â”‚ â€¢ Make approval decisions (Director's job)                  â”‚
â”‚ â€¢ Route Work Orders (Manager's job)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                       â”‚
         âœ“ SUCCESS                âœ— FAILURE
              â”‚                       â”‚
              â”‚                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤ CLIENT MANAGER (Phase 2.X)                                â”‚
â”‚ Human Interface Agent for Escalations                        â”‚
â”‚                                                              â”‚
â”‚ Responsibilities:                                            â”‚
â”‚ â€¢ Monitor all agent execution states across the system:     â”‚
â”‚   - Watch work_orders table for stuck/failed states         â”‚
â”‚   - Track escalations table for new entries                 â”‚
â”‚   - Monitor cost_tracking for budget anomalies              â”‚
â”‚   - Observe pattern_confidence_scores for quality           â”‚
â”‚     degradation                                              â”‚
â”‚ â€¢ Detect unresolvable issues:                               â”‚
â”‚   - Proposer exhausts retries after self-refinement         â”‚
â”‚     (2+ attempts failed)                                     â”‚
â”‚   - Sentinel hard failures (repeated test failures,         â”‚
â”‚     >3 cycles)                                               â”‚
â”‚   - Budget overruns beyond delegated authority              â”‚
â”‚     (approaching emergency_kill)                             â”‚
â”‚   - Conflicting requirements discovered mid-execution       â”‚
â”‚   - Unforeseen technical blockers (dependencies             â”‚
â”‚     unavailable, API changes)                                â”‚
â”‚   - Contract violations that can't be auto-resolved         â”‚
â”‚   - Aider reports irreconcilable state (file conflicts,     â”‚
â”‚     broken repo)                                             â”‚
â”‚ â€¢ Formulate resolution options (typically 2-4 alternatives):â”‚
â”‚   - Option A: Retry with different approach                 â”‚
â”‚   - Option B: Pivot technical solution                      â”‚
â”‚   - Option C: Amend earlier Work Orders                     â”‚
â”‚   - Option D: Abort and redesign                            â”‚
â”‚ â€¢ Cost/risk/timeline analysis per option:                   â”‚
â”‚   - Estimated additional cost                               â”‚
â”‚   - Success probability based on historical data            â”‚
â”‚   - Time to resolution                                      â”‚
â”‚   - Risk of compounding issues                              â”‚
â”‚ â€¢ Generate recommendation with clear reasoning:             â”‚
â”‚   - Preferred option with justification                     â”‚
â”‚   - Trade-offs of each alternative                          â”‚
â”‚   - Confidence level in recommendation                      â”‚
â”‚ â€¢ Present to human via Mission Control with full context:   â”‚
â”‚   - Failure history (all attempts + results)                â”‚
â”‚   - Cost spent so far                                       â”‚
â”‚   - Architect's original decomposition (for context)        â”‚
â”‚   - Relevant logs and metrics                               â”‚
â”‚   - Visual timeline of escalation                           â”‚
â”‚ â€¢ Execute human's decision:                                  â”‚
â”‚   - Amend Work Orders (update work_orders table)            â”‚
â”‚   - Reallocate resources (change proposer_configs)          â”‚
â”‚   - Trigger rollbacks (via Orchestrator)                    â”‚
â”‚   - Abort operations (mark work_orders as failed)           â”‚
â”‚   - Request Architect re-decomposition                      â”‚
â”‚ â€¢ Learn from human decisions:                               â”‚
â”‚   - Store resolution patterns in escalation_scripts         â”‚
â”‚   - Track which options humans prefer                       â”‚
â”‚   - Improve future recommendations                          â”‚
â”‚   - Identify automation opportunities (repeated manual      â”‚
â”‚     interventions)                                           â”‚
â”‚ â€¢ Track intervention patterns:                              â”‚
â”‚   - What categories of issues escalate most?                â”‚
â”‚   - Which agents trigger escalations?                       â”‚
â”‚   - What resolution patterns succeed?                       â”‚
â”‚   - Where can automation reduce escalations?                â”‚
â”‚                                                              â”‚
â”‚ Outputs: Escalation summaries with full context,            â”‚
â”‚          Option analysis (2-4 alternatives with             â”‚
â”‚          cost/risk/time), Recommendations with reasoning     â”‚
â”‚          and confidence level, Decision execution            â”‚
â”‚          confirmations, Learning patterns for future         â”‚
â”‚          escalations, Intervention trend reports             â”‚
â”‚                                                              â”‚
â”‚ Database:                                                    â”‚
â”‚ â€¢ Reads: All tables (needs full system visibility)          â”‚
â”‚ â€¢ Writes: escalations (creates escalation records),         â”‚
â”‚           escalation_scripts (stores learned resolution      â”‚
â”‚           patterns)                                          â”‚
â”‚ â€¢ Updates: work_orders.status when executing human          â”‚
â”‚            decisions                                         â”‚
â”‚ â€¢ References: decision_logs, outcome_vectors, cost_tracking â”‚
â”‚              for context                                     â”‚
â”‚                                                              â”‚
â”‚ User Interface:                                              â”‚
â”‚ â€¢ Mission Control escalation queue                          â”‚
â”‚ â€¢ Real-time alerts for critical issues                      â”‚
â”‚ â€¢ Option presentation with visual decision tree             â”‚
â”‚ â€¢ One-click decision execution                              â”‚
â”‚ â€¢ Escalation history view                                   â”‚
â”‚                                                              â”‚
â”‚ Does NOT:                                                    â”‚
â”‚ â€¢ Make final decisions on escalated issues (human's job -   â”‚
â”‚   Client Manager only recommends)                            â”‚
â”‚ â€¢ Generate code (Proposer's job)                            â”‚
â”‚ â€¢ Decompose specs (Architect's job)                         â”‚
â”‚ â€¢ Approve Work Orders (Director's job)                      â”‚
â”‚ â€¢ Execute deployments (Orchestrator infrastructure)         â”‚
â”‚ â€¢ Evaluate test results (Sentinel's job)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    â†» Back to HUMAN
                    (Reviews escalation options
                     and makes final decision)
```

---

## ğŸ”„ Feedback Loops & Learning

### Self-Refinement Loop (Proposer â†” Orchestrator/Aider)
1. Proposer generates code
2. Orchestrator/Aider applies + checks live state
3. Discrepancy detected (missing import, wrong file path, etc.)
4. Aider reports back to Proposer
5. Proposer refines with live context (max 2-3 attempts)
6. Success â†’ store pattern in playbook_memory

### Quality Learning Loop (Sentinel â†’ System)
1. Sentinel detects false positive (flaky test)
2. Pattern stored in pattern_confidence_scores
3. Future executions ignore known flaky tests
4. Reduces unnecessary escalations

### Escalation Learning Loop (Client Manager â†’ System)
1. Issue escalated to human
2. Human selects resolution option
3. Client Manager stores decision pattern
4. Similar future issues: Client Manager recommends proven solution
5. Eventually: automate resolution (no escalation needed)

### Budget Learning Loop (Manager â†’ Proposers)
1. Manager tracks cost per Work Order type
2. Learns which tasks can use cheaper models
3. Adjusts routing thresholds over time
4. Reduces costs while maintaining quality

---

## ğŸ—„ï¸ Database Schema Support

All agents integrate with Supabase tables:

- **work_orders** - Work Order lifecycle tracking
- **contracts** - API/domain contract validation
- **proposer_configs** - Model registry and capabilities
- **decision_logs** - Director approval audit trail
- **cost_tracking** - Budget monitoring and enforcement
- **outcome_vectors** - Historical performance metrics
- **pattern_confidence_scores** - Trust and learning patterns
- **playbook_memory** - Successful patterns and fixes
- **escalations** - Unresolved issues requiring human intervention
- **github_events** - Repository activity tracking
- **system_config** - Runtime configuration (budget limits, thresholds)

---

## ğŸ›ï¸ Key Architectural Principles

1. **Specialist Job Descriptions**: Each agent has clear, non-overlapping responsibilities

2. **Context Isolation**: Agents maintain only necessary context to prevent memory overflow

3. **Ephemeral Execution**: Aider instances spun up/torn down per Work Order (no persistent state)

4. **Progressive Autonomy**: Director auto-approves trusted patterns (confidence >0.95), escalates edge cases

5. **Learning Loops**: All agents feed patterns to shared memory (playbook_memory, pattern_confidence_scores)

6. **Budget Enforcement**: 3-tier system ($20 soft/$50 hard/$100 emergency) with graceful degradation

7. **Hard Stop Override**: Security/architecture keywords force best model even over budget

8. **Human-in-the-Loop**: Client Manager provides clear options + recommendations, never makes final decisions

9. **Live Feedback**: Aider eliminates stale assumptions by querying actual environment state

10. **Adaptive Quality**: Sentinel learns false positives and adjusts thresholds over time

---

## ğŸ“‹ Agent Responsibility Matrix

| Agent | Primary Function | Reads From | Writes To | Does NOT Do |
|-------|-----------------|------------|-----------|-------------|
| **Architect** | Strategic decomposition | contracts | work_orders | Approve risk, generate code, coordinate runtime, escalate, apply code |
| **Director** | Risk governance & approval | work_orders, contracts, pattern_confidence_scores | decision_logs, work_orders.status | Decompose specs, generate code, handle escalations, coordinate runtime, route to Proposers, apply code |
| **Manager** | Tactical coordination & routing | work_orders, proposer_configs, outcome_vectors, system_config, cost_tracking | work_orders.metadata (routing) | Create/decompose WOs, approve WOs, generate code, escalate to humans, assess risk, apply code |
| **Proposers** | Code generation | work_orders, proposer_configs, playbook_memory | cost_tracking, outcome_vectors, work_orders.metadata, pattern_confidence_scores | Decide routing, apply code to repo, validate execution, approve WOs, handle escalations |
| **Orchestrator** | Aider-based execution (infrastructure) | work_orders | github_events, work_orders (PR info), outcome_vectors | Make approval decisions, generate code, evaluate quality, route WOs, handle escalations |
| **Sentinel** | Adaptive quality validation | github_events, outcome_vectors | outcome_vectors, pattern_confidence_scores, playbook_memory, escalations | Generate code, create escalation options, apply fixes, approve WOs, route WOs |
| **Client Manager** | Human escalation interface | All tables | escalations, escalation_scripts, work_orders.status | Make final decisions (recommends only), generate code, decompose specs, approve WOs, execute deployments, evaluate tests |

---

**Document Version**: Final Consolidated Structure (2025-09-29)  
**System Version**: v22  
**Total Agents**: 6 (plus Orchestrator infrastructure)  
**Total Database Tables**: 11  
**Total Phases**: 2.0 through 4.1